<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Disney Magic Breath</title>
    <style>
        /* --- 1. 基础与背景设定 --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            font-family: -apple-system, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            touch-action: none;
            background-color: #090a1a;
        }

        /* 迪士尼风格魔法背景 (CSS动态星空) */
        #magic-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            z-index: 0; overflow: hidden;
        }
        .star {
            position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fff;
            animation: twinkle var(--duration) infinite ease-in-out; color: #fff;
        }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        /* --- 2. 核心功能层 --- */
        canvas#bubble-canvas { position: absolute; top: 0; left: 0; z-index: 10; pointer-events: none; }
        .input_video { display: none; }

        /* 魔法镜子 (摄像头预览) */
        #magic-mirror-container {
            position: absolute; top: 20px; right: 20px;
            width: 90px; height: 120px; z-index: 20;
            border-radius: 50% / 60%; /* 椭圆镜框 */
            padding: 4px;
            background: linear-gradient(45deg, #ffd700, #ffaa00, #ffd700); /* 金色边框 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: none; /* 开始后显示 */
        }
        #magic-mirror {
            width: 100%; height: 100%;
            border-radius: 50% / 60%; overflow: hidden;
            transform: scaleX(-1); border: 2px solid rgba(255,255,255,0.3);
            background: #000;
        }
        #preview-canvas { width: 100%; height: 100%; object-fit: cover; }
        /* 识别成功时的特效 */
        #magic-mirror-container.active {
            box-shadow: 0 0 25px #00d2ff, 0 0 50px #00d2ff inset;
        }

        /* --- 3. UI 界面层 --- */
        #ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 30; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* 通用卡片样式 (磨砂玻璃) */
        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px; padding: 30px; text-align: center;
            color: #fff; pointer-events: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 85%; width: 360px;
        }

        /* 加载屏幕 */
        #loading-screen {
            display: flex; flex-direction: column; align-items: center;
        }
        .magic-loader {
            width: 50px; height: 50px; position: relative; margin-bottom: 20px;
        }
        .magic-loader::before, .magic-loader::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; border: 3px solid transparent;
            border-top-color: #ffd700; border-bottom-color: #00d2ff;
            animation: magicSpin 1.5s linear infinite;
        }
        .magic-loader::after { animation-duration: 2.5s; border-top-color: #ff69b4; border-bottom-color: transparent; }
        @keyframes magicSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        h1 { font-size: 24px; margin: 0 0 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); font-weight: 700; letter-spacing: 1px;}
        p.sub-text { font-size: 14px; color: rgba(255,255,255,0.7); margin: 0 0 20px; line-height: 1.6; }

        /* 魔法按钮 */
        .magic-btn {
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
            border: none; padding: 16px 40px; border-radius: 50px;
            color: white; font-size: 18px; font-weight: bold;
            cursor: pointer; box-shadow: 0 10px 20px -10px rgba(0, 242, 254, 0.7);
            border-bottom: 3px solid #0099cc; position: relative; overflow: hidden;
            transition: all 0.2s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .magic-btn:active { transform: translateY(2px); border-bottom-width: 1px; }
        .magic-btn::after { /* 按钮光泽 */
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(to bottom right, rgba(255,255,255,0.4), transparent);
            transform: rotate(45deg); pointer-events: none;
        }

        #start-btn-container { display: none; }

        /* 游戏内 UI */
        #game-ui {
            display: none; /* 开始后显示 */
            position: absolute; bottom: 30px; width: 100%;
            text-align: center; pointer-events: none;
        }
        #settings-btn {
            pointer-events: auto;
            background: rgba(255,255,255,0.2); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3); color: #fff;
            padding: 10px 20px; border-radius: 20px; font-size: 14px;
            display: inline-flex; align-items: center; cursor: pointer;
        }
        #settings-btn svg { margin-right: 8px; fill: currentColor; }

        /* 设置弹窗 */
        #settings-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 50;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            position: relative;
        }
        .close-btn {
            position: absolute; top: 15px; right: 15px;
            width: 30px; height: 30px; background: rgba(255,255,255,0.2);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: pointer;
        }
        input[type=range] { width: 100%; accent-color: #ffd700; margin: 20px 0; }

    </style>
</head>
<body>

    <div id="magic-bg"></div>
    
    <video class="input_video" playsinline muted></video>
    <canvas id="bubble-canvas"></canvas>

    <div id="magic-mirror-container">
        <div id="magic-mirror">
            <canvas id="preview-canvas"></canvas>
        </div>
    </div>

    <div id="ui-container">
        
        <div id="loading-screen" class="glass-panel">
            <div class="magic-loader"></div>
            <h1>正在召唤魔法</h1>
            <p class="sub-text" id="loading-text">正在加载 AI 视觉引擎...<br>请确保网络通畅 (需要科学上网)</p>
        </div>

        <div id="start-btn-container" class="glass-panel">
            <h1>魔法准备就绪</h1>
            <p class="sub-text">请授予摄像头权限<br>对着魔镜做出“嘟嘴”动作吹气</p>
            <button id="btn-start" class="magic-btn">开启魔法之旅</button>
        </div>

        <div id="settings-modal">
            <div class="modal-content glass-panel">
                <div class="close-btn" id="close-settings">✕</div>
                <h3>魔法灵敏度调节</h3>
                <p class="sub-text" style="margin-bottom: 10px;">如果你用力吹气也不出泡泡，请向左滑动。</p>
                <input type="range" id="sensitivity" min="0.15" max="0.45" step="0.01" value="0.30">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: rgba(255,255,255,0.5);">
                    <span>容易触发</span><span>难以触发</span>
                </div>
            </div>
        </div>
    </div>

    <div id="game-ui">
        <button id="settings-btn">
            <svg xmlns="http://www.w3.org/2000/svg" height="18" width="18" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.68 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.04.24.24.41.48.41h3.84c.24 0 .43-.17.47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.08-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            设置灵敏度
        </button>
    </div>


    <script src="https://unpkg.com/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <script>
        // --- 1. 初始化背景星空 ---
        const magicBg = document.getElementById('magic-bg');
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = `${Math.random() * 100}%`;
            star.style.top = `${Math.random() * 100}%`;
            star.style.setProperty('--duration', `${Math.random() * 3 + 2}s`);
            const size = Math.random() * 2;
            star.style.width = `${size}px`; star.style.height = `${size}px`;
            magicBg.appendChild(star);
        }

        // --- 2. 变量与元素获取 ---
        const videoElement = document.getElementsByClassName('input_video')[0];
        const previewCanvas = document.getElementById('preview-canvas');
        const previewCtx = previewCanvas.getContext('2d');
        const canvas = document.getElementById('bubble-canvas');
        const ctx = canvas.getContext('2d');
        
        const loadingScreen = document.getElementById('loading-screen');
        const loadingText = document.getElementById('loading-text');
        const startBtnContainer = document.getElementById('start-btn-container');
        const startBtn = document.getElementById('btn-start');
        const magicMirrorContainer = document.getElementById('magic-mirror-container');
        const gameUI = document.getElementById('game-ui');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettings = document.getElementById('close-settings');

        let width, height;
        let bubbles = [];
        let isBlowing = false;
        let blowThreshold = 0.30; // 默认阈值

        // 设置相关交互
        document.getElementById('sensitivity').addEventListener('input', e => {
            blowThreshold = parseFloat(e.target.value);
        });
        settingsBtn.addEventListener('click', () => settingsModal.style.display = 'flex');
        closeSettings.addEventListener('click', () => settingsModal.style.display = 'none');

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            previewCanvas.width = 150; previewCanvas.height = 200;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- 3. 迪士尼风格泡泡 (白色透明拟真) ---
        class Bubble {
            constructor() {
                this.x = width / 2 + (Math.random() - 0.5) * 150;
                this.y = height + 50;
                this.size = Math.random() * 35 + 15; // 更大的泡泡
                this.speedY = Math.random() * 3 + 2;
                this.step = Math.random() * Math.PI;
                this.opacity = 1;
            }
            update() {
                this.y -= this.speedY;
                this.x += Math.cos(this.step += 0.04) * 1.5; // 轻微摇摆
                this.opacity -= 0.004; // 慢慢消失
            }
            draw() {
                ctx.globalAlpha = this.opacity;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
                
                // 核心：拟真白色透明渐变
                let gradient = ctx.createRadialGradient(
                    this.x, this.y, this.size * 0.6, // 内圆
                    this.x, this.y, this.size         // 外圆
                );
                // 中心完全透明 -> 边缘半透明白
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0)'); 
                gradient.addColorStop(0.8, 'rgba(255, 255, 255, 0.1)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0.3)');
                
                ctx.fillStyle = gradient;
                ctx.fill();

                // 边缘高光线圈
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.lineWidth = 1.5;
                ctx.stroke();

                // 添加一个强烈的高光点 (模拟光源反射)
                ctx.beginPath();
                // 在左上角画一个小椭圆
                ctx.ellipse(this.x - this.size*0.4, this.y - this.size*0.4, this.size*0.25, this.size*0.15, Math.PI/4, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.fill();

                ctx.globalAlpha = 1;
            }
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);
            if (isBlowing && Math.random() > 0.3) {
                bubbles.push(new Bubble()); // 喷射泡泡
            }
            for (let i = 0; i < bubbles.length; i++) {
                bubbles[i].update(); bubbles[i].draw();
                if (bubbles[i].y < -100 || bubbles[i].opacity <= 0) {
                    bubbles.splice(i, 1); i--;
                }
            }
            requestAnimationFrame(animate);
        }
        animate();

        // --- 4. AI 核心逻辑 ---
        function distance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        function onResults(results) {
            // 绘制镜像预览
            previewCtx.save();
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            previewCtx.drawImage(results.image, 0, 0, previewCanvas.width, previewCanvas.height);
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const lm = results.multiFaceLandmarks[0];
                // 仅绘制嘴唇线条，颜色为金色魔法光
                drawConnectors(previewCtx, lm, FACEMESH_LIPS, {color: '#ffd700', lineWidth: 2});

                // 计算嘴巴高宽比
                const h = distance(lm[13], lm[14]);
                const w = distance(lm[61], lm[291]);
                const ratio = h / w;

                // 核心判断：比率大于阈值则认为在嘟嘴
                if (ratio > blowThreshold) {
                    isBlowing = true;
                    magicMirrorContainer.classList.add('active'); // 镜子发光
                } else {
                    isBlowing = false;
                    magicMirrorContainer.classList.remove('active');
                }
            } else {
                isBlowing = false;
                 magicMirrorContainer.classList.remove('active');
            }
            previewCtx.restore();
        }

        // --- 5. 系统启动流程 ---
        // 超时检测
        setTimeout(() => {
            if (loadingScreen.style.display !== 'none') {
                loadingText.innerHTML = "<span style='color:#ff6b6b'>加载超时</span><br>AI 模型下载失败，请检查 VPN 设置。<br>建议开启全局代理模式后刷新。";
            }
        }, 15000); // 15秒超时

        async function init() {
            try {
                const faceMesh = new FaceMesh({locateFile: (file) => `https://unpkg.com/@mediapipe/face_mesh/${file}`});
                faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                faceMesh.onResults(onResults);

                // AI加载完毕，切换界面
                loadingScreen.style.display = 'none';
                startBtnContainer.style.display = 'flex';

                startBtn.addEventListener('click', async () => {
                    startBtn.innerText = "正在启动魔镜...";
                    startBtn.disabled = true;
                    try {
                        const camera = new Camera(videoElement, {
                            onFrame: async () => { await faceMesh.send({image: videoElement}); },
                            width: 480, height: 640
                        });
                        await camera.start();
                        // 摄像头启动成功，进入游戏状态
                        startBtnContainer.style.display = 'none';
                        magicMirrorContainer.style.display = 'block';
                        gameUI.style.display = 'block';
                    } catch (e) {
                        console.error(e);
                        alert("无法启动摄像头，请检查浏览器权限设置。");
                        startBtn.innerText = "启动失败";
                    }
                });
            } catch (e) {
                console.error(e);
                loadingText.innerText = "初始化失败，请刷新重试";
            }
        }

        // 页面加载后开始初始化
        window.onload = init;

    </script>
</body>
</html>
