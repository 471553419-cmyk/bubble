<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Bubbles</title>
    <style>
        * { box-sizing: border-box; }
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%); /* 糖果渐变 */
            font-family: -apple-system, sans-serif;
            touch-action: none;
        }

        /* 视频层：全屏显示，做镜像处理 */
        #video-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* 像照镜子一样 */
            z-index: 1;
            filter: brightness(1.1); /*稍微提亮一点 */
        }

        /* 泡泡画布 */
        #bubble-canvas {
            position: absolute; top: 0; left: 0; z-index: 10;
        }

        /* UI 层 */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* 感应圈：告诉用户嘴巴对准哪里 */
        #target-circle {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 120px; height: 120px;
            border: 3px dashed rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3); /* 聚光灯效果 */
            transition: all 0.2s;
            display: none; /* 开始后显示 */
        }
        
        /* 吹气成功时的特效 */
        #target-circle.active {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.2);
            box-shadow: 0 0 30px #00ff88, 0 0 0 9999px rgba(0, 0, 0, 0.3);
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* 提示文字 */
        #hint-text {
            position: absolute;
            top: 35%; /* 在圆圈上方 */
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-size: 16px;
            text-align: center;
            display: none;
        }

        /* 启动面板 */
        #start-panel {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 80%;
            max-width: 320px;
            pointer-events: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        h2 { margin: 0 0 10px 0; color: #333; }
        p { color: #666; font-size: 14px; margin-bottom: 20px; }

        button {
            background: linear-gradient(45deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(255, 154, 158, 0.4);
            cursor: pointer;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* 灵敏度滑块 */
        #slider-box {
            position: absolute;
            bottom: 40px;
            width: 80%;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 30px;
            color: white;
            text-align: center;
            display: none;
            pointer-events: auto;
        }
    </style>
</head>
<body>

    <video id="video-layer" playsinline muted></video>
    
    <canvas id="bubble-canvas"></canvas>

    <div id="target-circle"></div>
    <div id="hint-text">将嘴巴对准圆圈<br>用力吹气（动作幅度大一点）</div>

    <div id="ui-layer">
        <div id="start-panel">
            <h2>✨ 魔法泡泡</h2>
            <p>无需等待，点击即玩<br>请允许摄像头权限</p>
            <button id="btn-start">开始</button>
        </div>
    </div>

    <div id="ui-layer">
        <div id="slider-box">
            <div style="font-size:12px;margin-bottom:8px">灵敏度调节 (如果不出泡泡往左拉)</div>
            <input type="range" id="sensitivity" min="5" max="30" step="1" value="12" style="width:100%">
        </div>
    </div>

    <script>
        const video = document.getElementById('video-layer');
        const canvas = document.getElementById('bubble-canvas');
        const ctx = canvas.getContext('2d');
        const startPanel = document.getElementById('start-panel');
        const targetCircle = document.getElementById('target-circle');
        const hintText = document.getElementById('hint-text');
        const sliderBox = document.getElementById('slider-box');
        const startBtn = document.getElementById('btn-start');
        
        // 运动检测画布（不可见）
        const motionCanvas = document.createElement('canvas');
        const motionCtx = motionCanvas.getContext('2d');
        
        let width, height;
        let bubbles = [];
        let isRunning = false;
        let lastImageData = null;
        
        // 灵敏度：像素变化阈值。越小越灵敏。
        let threshold = 12; 

        document.getElementById('sensitivity').addEventListener('input', (e) => {
            threshold = parseInt(e.target.value);
        });

        // 1. 初始化全屏
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        // 2. 泡泡逻辑
        class Bubble {
            constructor() {
                this.x = width / 2 + (Math.random() - 0.5) * 100;
                this.y = height / 2 + 50; // 从圆圈附近出来
                this.size = Math.random() * 20 + 10;
                this.speedY = Math.random() * 3 + 2;
                this.step = Math.random() * Math.PI;
                this.hue = Math.random() * 360;
                this.opacity = 1;
            }
            update() {
                this.y -= this.speedY;
                this.x += Math.cos(this.step += 0.05);
                this.opacity -= 0.005;
            }
            draw() {
                ctx.globalAlpha = this.opacity;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
                
                // 梦幻着色
                let g = ctx.createRadialGradient(
                    this.x - this.size/3, this.y - this.size/3, this.size/10,
                    this.x, this.y, this.size
                );
                g.addColorStop(0, `hsla(${this.hue}, 100%, 90%, 1)`);
                g.addColorStop(1, `hsla(${this.hue}, 100%, 60%, 0.3)`);
                
                ctx.fillStyle = g;
                ctx.fill();
                ctx.strokeStyle = "rgba(255,255,255,0.6)";
                ctx.stroke();
                ctx.globalAlpha = 1;
            }
        }

        // 3. 核心算法：简单的运动检测
        function detectMotion() {
            if (!isRunning) return;

            // 为了性能，我们把视频缩小处理
            const w = 64; 
            const h = 64;
            motionCanvas.width = w;
            motionCanvas.height = h;
            
            // 将视频中心区域绘制到小画布
            // 我们只检测画面中心（对应圆圈位置）
            const sourceX = video.videoWidth / 2 - video.videoWidth / 6;
            const sourceY = video.videoHeight / 2 - video.videoHeight / 6;
            const sourceW = video.videoWidth / 3;
            const sourceH = video.videoHeight / 3;

            motionCtx.drawImage(video, sourceX, sourceY, sourceW, sourceH, 0, 0, w, h);
            
            const frame = motionCtx.getImageData(0, 0, w, h);
            const data = frame.data;

            if (lastImageData) {
                let diffScore = 0;
                // 遍历像素对比
                for (let i = 0; i < data.length; i += 4) {
                    // 对比 RGB 差异
                    const rDiff = Math.abs(data[i] - lastImageData[i]);
                    const gDiff = Math.abs(data[i+1] - lastImageData[i+1]);
                    const bDiff = Math.abs(data[i+2] - lastImageData[i+2]);
                    
                    // 如果单像素差异大，计分
                    if (rDiff + gDiff + bDiff > 50) {
                        diffScore++;
                    }
                }

                // 这里的阈值决定了多大的动作触发
                // threshold 越小，需要变动的像素越少
                // 调节 diffScore 的判断标准
                if (diffScore > (threshold * 5)) { 
                    // 检测到吹气/动作！
                    targetCircle.classList.add('active');
                    // 生成泡泡
                    bubbles.push(new Bubble());
                    if(Math.random() > 0.5) bubbles.push(new Bubble());
                } else {
                    targetCircle.classList.remove('active');
                }
            }

            // 保存当前帧用于下次对比
            lastImageData = data;
        }

        // 4. 动画循环
        function loop() {
            ctx.clearRect(0, 0, width, height);
            
            if (isRunning && video.readyState === video.HAVE_ENOUGH_DATA) {
                detectMotion();
            }

            for (let i = 0; i < bubbles.length; i++) {
                bubbles[i].update();
                bubbles[i].draw();
                if (bubbles[i].y < -50 || bubbles[i].opacity <= 0) {
                    bubbles.splice(i, 1);
                    i--;
                }
            }
            requestAnimationFrame(loop);
        }

        // 5. 启动
        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "user", // 前置摄像头
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }, 
                    audio: false 
                });
                video.srcObject = stream;
                video.play();
                
                isRunning = true;
                startPanel.style.display = 'none';
                targetCircle.style.display = 'block';
                hintText.style.display = 'block';
                sliderBox.style.display = 'block';
                
                loop();
                
            } catch (err) {
                alert("无法启动摄像头，请检查权限。");
                console.error(err);
            }
        });

    </script>
</body>
</html>
